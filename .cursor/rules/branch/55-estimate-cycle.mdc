---
description: 55-estimate-cycleãƒ–ãƒ©ãƒ³ãƒã§ã®é–‹ç™ºæ™‚ã«èª­ã¿è¾¼ã‚€
alwaysApply: false
---
55-estimate-cycle ãƒ–ãƒ©ãƒ³ãƒãƒ«ãƒ¼ãƒ«
===

ã“ã®ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè£…ã™ã‚‹ã“ã¨ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
- ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚­ãƒ£ãƒ‹ã‚¹ã‚¿ãƒ¼ã‚’å‘¼ã³å‡ºã™æ™‚ã«ã€cycleé‡ã‚’è¨ˆç®—ã—ã€å¿…è¦ãªã ã‘è£œå……ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹
- å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:
  - `src/nicp_cdk/canisters/management_canister/http_outcall.nim`
  - `src/nicp_cdk/canisters/management_canister/t_ecdsa.nim`

## ãƒ‡ãƒãƒƒã‚°ç”¨å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```bash
# t_ecdsaã®ä¾‹ã‚’ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãƒ†ã‚¹ãƒˆ
cd /application
make deploy-local-t_ecdsa
dfx canister call t_ecdsa_backend public_key '()'
dfx canister call t_ecdsa_backend sign '(record { message_hash = blob "\00\01\02\03\04\05\06\07\08\09\0a\0b\0c\0d\0e\0f\10\11\12\13\14\15\16\17\18\19\1a\1b\1c\1d\1e\1f" })'
```

## é€²æ—
- [x] `http_outcall.nim`ã®èª¿æŸ»
  - [x] ç¾åœ¨ã®cycleè£œå……å‡¦ç†ã‚’ç¢ºèª
  - [x] `estimateHttpOutcallCost`é–¢æ•°ã®å‹•ä½œã‚’ç¢ºèª
  - [x] `ic0_cost_http_request`ã®ä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèª
- [x] `t_ecdsa.nim`ã®èª¿æŸ»
  - [x] ç¾åœ¨ã®cycleè£œå……å‡¦ç†ã‚’ç¢ºèªï¼ˆå®šæ•°`EcdsaCallCycles`ã‚’ä½¿ç”¨ï¼‰
  - [x] `ic0_cost_sign_with_ecdsa`ãŒä½¿ãˆã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆ`ic0.nim`ã«å®£è¨€ã‚ã‚Šï¼‰
- [x] cycleè¨ˆç®—å‡¦ç†ã®å®Ÿè£…
  - [x] `http_outcall.nim`ã®`httpRequest`é–¢æ•°ã§cycleè¨ˆç®—ã‚’å®Ÿè£…
  - [x] `t_ecdsa.nim`ã®`publicKey`é–¢æ•°ã§cycleè¨ˆç®—ã‚’å®Ÿè£…
  - [x] `t_ecdsa.nim`ã®`sign`é–¢æ•°ã§cycleè¨ˆç®—ã‚’å®Ÿè£…
- [x] ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°
  - [x] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ—ãƒªã‚«ã§ãƒ†ã‚¹ãƒˆ
  - [x] cycleé‡ãŒé©åˆ‡ã‹ç¢ºèªï¼ˆ`signWithEthereum`ãŒæ­£å¸¸ã«å‹•ä½œï¼‰

## å‚è€ƒè³‡æ–™
- IC System API: https://internetcomputer.org/docs/current/references/ic-interface-spec/#system-api-imports
- `ic0_cost_http_request`: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ­£ç¢ºãªcycleé‡ã‚’è¨ˆç®—
- `ic0_cost_sign_with_ecdsa`: ECDSAç½²åã®æ­£ç¢ºãªcycleé‡ã‚’è¨ˆç®—
- Internet Computeré–‹ç™ºè€…ãƒ•ã‚©ãƒ¼ãƒ©ãƒ : https://forum.dfinity.org
- ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:
  - `http_outcall.nim`: `estimateHttpOutcallCost`é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ãŒã€å®Ÿéš›ã«ã¯ä½¿ã‚ã‚Œã¦ã„ãªã„
  - `t_ecdsa.nim`: å®šæ•°`EcdsaCallCycles = 26_153_846_153'u64`ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ä½¿ç”¨

### `ic0_cost_sign_with_ecdsa`ã®æ­£ã—ã„ä½¿ç”¨æ–¹æ³•ï¼ˆWebæ¤œç´¢çµæœã‚ˆã‚Šï¼‰

#### é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ï¼ˆic0.nimï¼‰
```nim
proc ic0_cost_sign_with_ecdsa*(src: int, size: int, ecdsa_curve: uint32, dst: int): uint32
```

#### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- `src`: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å…ˆé ­ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆCandidã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ï¼‰
- `size`: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒˆã‚µã‚¤ã‚º
- `ecdsa_curve`: æ›²ç·šã‚¿ã‚¤ãƒ—ï¼ˆsecp256k1 = 0, secp256r1 = 1ï¼‰
- `dst`: çµæœï¼ˆ128bit cyclesï¼‰ã‚’æ ¼ç´ã™ã‚‹ãƒãƒƒãƒ•ã‚¡ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
- **æˆ»ã‚Šå€¤**: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆ0 = æˆåŠŸã€é0 = ã‚¨ãƒ©ãƒ¼ï¼‰

#### ä½¿ç”¨æ‰‹é †
1. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æº–å‚™ï¼ˆCandidã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼‰
2. `ic0_cost_sign_with_ecdsa`ã‚’å‘¼ã³å‡ºã—ã¦cycleé‡ã‚’è¨ˆç®—
3. è¿”ã•ã‚ŒãŸcycleæ•°ã‚’`ic0_call_cycles_add128`ã§è¿½åŠ 
4. `sign_with_ecdsa`ã‚’å®Ÿè¡Œ

#### Nimå®Ÿè£…ä¾‹
```nim
proc estimateEcdsaCost(keyId: EcdsaKeyId, payload: seq[uint8]): uint64 =
  try:
    let curveValue = uint32(keyId.curve.ord)
    var costBuffer: array[16, uint8]  # 128bit for cycles
    
    let apiResult = ic0_cost_sign_with_ecdsa(
      ptrToInt(addr payload[0]),       # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å…ˆé ­ã‚¢ãƒ‰ãƒ¬ã‚¹
      payload.len,                     # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚º
      curveValue,                      # ECDSAæ›²ç·šã‚¿ã‚¤ãƒ—
      ptrToInt(addr costBuffer[0])     # çµæœã‚’æ ¼ç´ã™ã‚‹ãƒãƒƒãƒ•ã‚¡
    )
    
    if apiResult != 0:
      return EcdsaCallCyclesFallback   # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    
    # 128bitå€¤ã‚’64bitã«å¤‰æ›
    var exactCost: uint64 = 0
    for i in 0..<8:
      exactCost = exactCost or (uint64(costBuffer[i]) shl (i * 8))
    
    return exactCost + (exactCost div 5)  # +20%ãƒãƒ¼ã‚¸ãƒ³
  except Exception:
    return EcdsaCallCyclesFallback
```

#### é‡è¦ãªæ³¨æ„ç‚¹
- ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯**Candidã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿**ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
- APIã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è§£æã—ã¦ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- å®Ÿéš›ã®cycleé‡ã¯`dst`ãƒãƒƒãƒ•ã‚¡ã«128bitå€¤ã¨ã—ã¦æ ¼ç´ã•ã‚Œã‚‹
- æˆ»ã‚Šå€¤ã¯ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Šã€cycleé‡ã§ã¯ãªã„

## èª¿æŸ»çµæœãƒ»è¨­è¨ˆã¾ã¨ã‚

### å®Ÿè£…å®Œäº†ã—ãŸå†…å®¹

1. **http_outcall.nim**:
   - æ—¢å­˜ã®`estimateHttpOutcallCost`é–¢æ•°ã‚’`httpRequest`é–¢æ•°å†…ã§ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
   - `ic0_call_cycles_add128`ã‚’ä½¿ã£ã¦è¨ˆç®—ã—ãŸcycleé‡ã‚’è¿½åŠ 
   - `ic0_cost_http_request` APIã‚’ä½¿ç”¨ã—ã¦æ­£ç¢ºãªcycleé‡ã‚’è¨ˆç®—ï¼ˆ20%ã®å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³è¾¼ã¿ï¼‰
   
2. **t_ecdsa.nim**:
   - æ–°ã—ã„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’è¿½åŠ :
     - `estimateEcdsaCost(keyId: EcdsaKeyId, payloadSize: int): uint64` - ECDSAç½²åãƒ»å…¬é–‹éµå–å¾—å…±é€š
   - **æ³¨**: `ic0_cost_sign_with_ecdsa` APIã¯æ­£ã—ã„ä½¿ç”¨æ–¹æ³•ãŒä¸æ˜ç¢ºãªãŸã‚ã€ç¾åœ¨ã¯ä½¿ç”¨ã—ã¦ã„ãªã„
   - ä»£ã‚ã‚Šã«ã€å›ºå®šã®ãƒ™ãƒ¼ã‚¹å€¤ã«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã«å¿œã˜ãŸèª¿æ•´ã‚’åŠ ãˆã‚‹æ–¹å¼ã‚’æ¡ç”¨
   - å›ºå®šå€¤`EcdsaCallCycles`ã‚’`EcdsaCallCyclesFallback`ã«åç§°å¤‰æ›´ã—ã€ãƒ™ãƒ¼ã‚¹å€¤ã¨ã—ã¦ä½¿ç”¨
   - `publicKey`é–¢æ•°ã¨`sign`é–¢æ•°ã§å…±é€šã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦cycleã‚’è¿½åŠ 
   - å¼•æ•°ã‹ã‚‰å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹ã®ã¯`key_id`ã®ã¿ãªã®ã§ã€é–¢æ•°ã‚’å…±é€šåŒ–ã—ã¦ã‚³ãƒ¼ãƒ‰é‡è¤‡ã‚’å‰Šæ¸›
   
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
   - cycleè¨ˆç®—APIãŒå¤±æ•—ã—ãŸå ´åˆï¼ˆéã‚¼ãƒ­ã‚’è¿”ã—ãŸå ´åˆï¼‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè£…
   - ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚åŒæ§˜ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’ä½¿ç”¨
   - ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›ã‚’è¿½åŠ 

### æŠ€è¡“çš„ãªæ³¨æ„ç‚¹ã¨ä»Šå¾Œã®æ”¹å–„

#### ç¾åœ¨ã®å®Ÿè£…
- `ic0_cost_ecdsa_public_key`ã¨ã„ã†å°‚ç”¨APIã¯å­˜åœ¨ã—ãªã„
- `ic0_cost_sign_with_ecdsa`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«Candidãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€ä¸€æ™‚çš„ã«å›ºå®šå€¤ã‚’ä½¿ç”¨
- **æš«å®šå®Ÿè£…**: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã«åŸºã¥ã„ãŸç°¡æ˜“çš„ãªæ¨å®šï¼ˆ1000ãƒã‚¤ãƒˆä»¥ä¸Šã§10%å¢—é‡ï¼‰

#### Webæ¤œç´¢ã§åˆ¤æ˜ã—ãŸæ­£ã—ã„ä½¿ç”¨æ–¹æ³•
ä¸Šè¨˜ã®ã€Œ`ic0_cost_sign_with_ecdsa`ã®æ­£ã—ã„ä½¿ç”¨æ–¹æ³•ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜è¼‰ã®é€šã‚Šã€ä»¥ä¸‹ã®ç‚¹ãŒé‡è¦ï¼š
1. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯**Candidã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿**ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ï¼ˆã“ã‚Œã¯å®Ÿè£…æ¸ˆã¿ï¼‰
2. æˆ»ã‚Šå€¤ã¯ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã€cycleé‡ã¯`dst`ãƒãƒƒãƒ•ã‚¡ã«æ ¼ç´ã•ã‚Œã‚‹ï¼ˆã“ã‚Œã‚‚å®Ÿè£…æ¸ˆã¿ï¼‰
3. APIã®å®Ÿè£…ä¾‹ã¨ã—ã¦ã¯æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãŸ

#### ã‚¨ãƒ©ãƒ¼ã®åŸå› ï¼ˆæ¨æ¸¬ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ—ãƒªã‚«ã®`ic0_cost_sign_with_ecdsa`å®Ÿè£…ãŒå®Œå…¨ã§ãªã„å¯èƒ½æ€§
- å®Ÿéš›ã®ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã‚„ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§ã¯å‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- ã¾ãŸã¯ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å½¢å¼ã«ä½•ã‹ç‰¹æ®Šãªè¦ä»¶ãŒã‚ã‚‹å¯èƒ½æ€§

#### ä»Šå¾Œã®æ”¹å–„è¨ˆç”»
1. ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆ/ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§`ic0_cost_sign_with_ecdsa`ã‚’è©¦ã—ã¦ã¿ã‚‹
2. å‹•ä½œã™ã‚Œã°ã€å›ºå®šå€¤ã‹ã‚‰å‹•çš„è¨ˆç®—ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
3. ç¾åœ¨ã®è¨­è¨ˆã¯åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€`estimateEcdsaCost`é–¢æ•°ã®ä¸­èº«ã‚’å·®ã—æ›¿ãˆã‚‹ã ã‘ã§OK

#### ãã®ä»–ã®æ³¨æ„ç‚¹
- Nimã®ç‰¹æ®Šå¤‰æ•°`result`ã¨ã®ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã‚’é¿ã‘ã‚‹ãŸã‚ã€å¤‰æ•°åã«æ³¨æ„
- cycleè¨ˆç®—ã¯å¸¸ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼ˆ20%ãƒãƒ¼ã‚¸ãƒ³æ¨å¥¨ï¼‰

### ãƒ†ã‚¹ãƒˆæ–¹æ³•
ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ—ãƒªã‚«ã§t_ecdsaã®ä¾‹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãƒ†ã‚¹ãƒˆ:
```bash
make deploy-local-t_ecdsa
dfx canister call t_ecdsa_backend public_key '()'
dfx canister call t_ecdsa_backend sign '(record { message_hash = blob "\00\01\02\03\04\05\06\07\08\09\0a\0b\0c\0d\0e\0f\10\11\12\13\14\15\16\17\18\19\1a\1b\1c\1d\1e\1f" })'
```

ãƒ­ã‚°å‡ºåŠ›ã§ä»¥ä¸‹ã‚’ç¢ºèª:
- `ğŸ“Š Estimated ECDSA sign cost:` - è¨ˆç®—ã•ã‚ŒãŸcycleé‡
- `Adding cycles for ECDSA public_key:` / `Adding cycles for ECDSA sign:` - è¿½åŠ ã•ã‚Œã‚‹cycleé‡
